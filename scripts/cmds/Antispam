module.exports = {
  config: {
    name: "antispam",
    version: "1.0",
    author: "Evariste á¬á‰á¯á’á¨á•á¿á¬",
    description: "Supprime automatiquement les spammeurs qui envoient de longs messages",
    usage: "[on/off/status]",
    cooldown: 5,
    permissions: [2],
  },

  onStart: async function ({ api, event, args, threadsData }) {
    const { threadID, messageID, senderID } = event;
    const botAdmins = global.GoatBot.config?.adminBot || [];
    if (!botAdmins.includes(senderID)) {
      return api.sendMessage("ğŸ”’ Seuls les administrateurs du bot peuvent activer lâ€™anti-spam.", threadID, messageID);
    }

    const action = args[0]?.toLowerCase();
    const current = await threadsData.get(threadID, "antiSpamActive") || false;

    if (!action || action === "status") {
      return api.sendMessage(
        `ğŸ›¡ï¸ Anti-spam : ${current ? "ACTIF" : "INACTIF"}\nâ€¢ Supprime les messages > 100 caractÃ¨res\n\nUtilisation : /antispam on | off | status`,
        threadID,
        messageID
      );
    }

    if (action === "on") {
      await threadsData.set(threadID, true, "antiSpamActive");
      return api.sendMessage("âœ… Anti-spam ACTIVÃ‰\nLes spammeurs seront supprimÃ©s automatiquement.\n\ná¬á‰á¯á’á¨á•á¿á¬", threadID, messageID);
    }

    if (action === "off") {
      await threadsData.set(threadID, false, "antiSpamActive");
      return api.sendMessage("âŒ Anti-spam DÃ‰SACTIVÃ‰\nAucune suppression automatique.\n\ná¬á‰á¯á’á¨á•á¿á¬", threadID, messageID);
    }

    return api.sendMessage("â“ Utilisation : /antispam [on|off|status]", threadID, messageID);
  },

  onEvent: async function ({ api, event, threadsData }) {
    const { threadID, senderID, body } = event;

    if (!body || typeof body !== "string") return;

    const isActive = await threadsData.get(threadID, "antiSpamActive");
    if (!isActive) return;

    const botAdmins = global.GoatBot.config?.adminBot || [];
    if (botAdmins.includes(senderID)) return;

    const isLongMessage = body.length > 100;

    if (isLongMessage) {
      try {
        await api.removeUserFromGroup(senderID, threadID);
        await api.sendMessage(
          `ğŸš« Un utilisateur a Ã©tÃ© supprimÃ© pour avoir envoyÃ© un message trop long !\nSignÃ© : á¬á‰á¯á’á¨á•á¿á¬`,
          threadID
        );
      } catch (err) {
        console.error("Erreur lors de la suppression du spammeur :", err);
      }
    }
  }
};
