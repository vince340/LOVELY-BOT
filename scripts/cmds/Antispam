module.exports = {
  config: {
    name: "antispam",
    version: "3.1",
    author: "Samir & Evariste",
    description: "Anti-spam avec suppression et expulsion automatique",
    usage: "[on/off/status]",
    cooldown: 5,
    permissions: [2],
    credits: "Ã‰quipe GoatBot + Evariste"
  },

  // â• COMMANDE MANUELLE
  onStart: async function({ api, event, args, threadsData }) {
    const { threadID, messageID, senderID } = event;
    const botAdmins = global.GoatBot.config?.adminBot || [];

    if (!botAdmins.includes(senderID)) {
      return api.sendMessage(
        "ğŸ”’ Seuls les admins du bot peuvent utiliser cette commande.",
        threadID, messageID
      );
    }

    const currentStatus = await threadsData.get(threadID, "antiSpam") || false;
    const action = args[0]?.toLowerCase();

    if (!action) {
      return api.sendMessage(
        `ğŸ›¡ï¸ Ã‰tat anti-spam : ${currentStatus ? "ACTIF" : "INACTIF"}\n` +
        `DÃ©tection :\nâ€¢ Messages > 100 caractÃ¨res\nâ€¢ Texte en MAJUSCULES (>70%)\n\n` +
        `Utilisation : /antispam [on|off|status]`,
        threadID, messageID
      );
    }

    if (action === "on") {
      if (currentStatus) return api.sendMessage("â„¹ï¸ DÃ©jÃ  activÃ©.", threadID, messageID);
      await threadsData.set(threadID, true, "antiSpam");
      return api.sendMessage("âœ… Anti-spam ACTIVÃ‰.", threadID, messageID);
    }

    if (action === "off") {
      if (!currentStatus) return api.sendMessage("â„¹ï¸ DÃ©jÃ  dÃ©sactivÃ©.", threadID, messageID);
      await threadsData.set(threadID, false, "antiSpam");
      return api.sendMessage("âŒ Anti-spam DÃ‰SACTIVÃ‰.", threadID, messageID);
    }

    if (action === "status") {
      return api.sendMessage(
        `ğŸ“Š Anti-spam : ${currentStatus ? "ACTIF" : "INACTIF"}\n` +
        `Mise Ã  jour : ${new Date().toLocaleString()}`,
        threadID, messageID
      );
    }

    return api.sendMessage("âŒ Utilisation : /antispam [on|off|status]", threadID, messageID);
  },

  // ğŸ”¥ TRAITEMENT AUTOMATIQUE
  onEvent: async function({ api, event, threadsData }) {
    const { threadID, senderID, messageID, body } = event;

    // Filtrage : si pas de texte â†’ on ignore
    if (!body || typeof body !== "string" || body.trim().length === 0) return;

    // VÃ©rifie si activÃ©
    const isEnabled = await threadsData.get(threadID, "antiSpam");
    if (!isEnabled) return;

    // ParamÃ¨tres anti-spam
    const MAX_LENGTH = 100;
    const CAPS_THRESHOLD = 0.7;

    const trimmedBody = body.trim();
    const bodyLength = trimmedBody.length;
    const uppercaseCount = (trimmedBody.match(/[A-Z]/g) || []).length;
    const capsRatio = uppercaseCount / bodyLength;

    const isTooLong = bodyLength > MAX_LENGTH;
    const isCapsAbuse = capsRatio > CAPS_THRESHOLD;

    if (!isTooLong && !isCapsAbuse) return; // Aucun spam dÃ©tectÃ©

    try {
      await api.unsendMessage(messageID); // Supprime le message

      // VÃ©rifie si le bot est admin pour expulser
      const threadInfo = await api.getThreadInfo(threadID);
      const botID = api.getCurrentUserID();
      const botIsAdmin = threadInfo.adminIDs.some(e => e.id === botID);

      if (botIsAdmin) {
        await api.removeUserFromGroup(senderID, threadID);
        return api.sendMessage(
          `ğŸš« Utilisateur expulsÃ© pour SPAM\nMotif : ${isTooLong ? "Message trop long" : "Trop de majuscules"}\nğŸ” SystÃ¨me anti-spam dâ€™Evariste`,
          threadID
        );
      } else {
        return api.sendMessage(
          `âš ï¸ Spam dÃ©tectÃ© : message supprimÃ©\nğŸ” SystÃ¨me anti-spam dâ€™Evariste (le bot n'est pas admin)`,
          threadID
        );
      }

    } catch (err) {
      console.error("Erreur anti-spam :", err);
    }
  }
};
